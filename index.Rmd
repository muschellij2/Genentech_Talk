---
title: 'Robust Lesion Segmentation on MRI of Patients with Multiple Sclerosis'
author: "John Muschelli, PhD - Johns Hopkins Bloomberg School of Public Health<br/> http://johnmuschelli.com/Genentech_Talk_2018.html"
date: "April 30, 2018"
output:
  ioslides_presentation:
    css: custom.css
    widescreen: yes
bibliography: refs.bib
---


```{r opts, include = FALSE}
library(knitr)
library(knitcitations)
library(dplyr)
library(tableone)
library(broom)
library(pander)
cite_options(max.names = 1)
opts_chunk$set(echo = FALSE, prompt = FALSE, message = FALSE, warning = FALSE, comment = "", results = 'hide')
```


```{r result, prompt=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
results = readr::read_rds("seg_reslts.rds")
df = results %>% 
  select(id, group, volume, smooth) %>% 
  distinct() %>% 
  arrange(id)
group_df = df
pick_examples = results %>% 
  filter(group == "test", run_model == "RF, no T1Post") %>% 
  mutate(dice_order = order(dice))
ind = floor( nrow(pick_examples)/2)
id = pick_examples[ ind, ]
id_high = pick_examples[ 3, ]
overall = readr::read_rds("overall_seg_reslts.rds")
```

```{r setup, prompt=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
load("cs_demog.rda")
cs = cs_demog
cs = cs %>% 
  mutate(type = recode(ms_type,
    "CIS" = "Clinically Isolated Syndrome",
    "RR" = "Relapsing-remitting", 
    SP = "Secondary-progressive", 
    PP = "Primary-progressive",
    PR = "Progressive-relapsing")
  )
cs$type[ is.na(cs$type)] = "Unspecified"
## Vector of variables to summarize
conVars <- c("Age", "EDSS", "Lesion_Volume")
## Vector of categorical variables that need transformation
catVars <- c("sex", "MS_Subtype")
cs$MS_Subtype = factor(cs$type)
cs$Sex = factor(cs$sex)
cs = left_join(cs, df)
cs = cs %>% 
  dplyr::rename(EDSS = edss,
         Age = age,
         Lesion_Volume = volume)
```



```{r}
## Create a TableOne object
demog_tab <- CreateTableOne(
  vars = c("Age", "sex", "EDSS", "Lesion_Volume", "MS_Subtype"), 
  data = cs, factorVars = catVars)
tabAsStringMatrix <- print(demog_tab, printToggle = FALSE, noSpaces = TRUE)
tabAsStringMatrix = as.data.frame(tabAsStringMatrix, stringsAsFactors = FALSE)
tabAsStringMatrix = tibble::rownames_to_column(tabAsStringMatrix, var = "Variable")

demog_tab_by_group = CreateTableOne(
  strata = "group",
  vars = c(conVars, catVars), 
  data = cs, factorVars = catVars, test = FALSE)
```


## Overview of Work/Research

<div style='font-size: 28pt;'>
- Neuroimaging and R (Neuroconductor Project)
- R Package Development/"Data Science"
- Segmentation/Classification of:
    - White Matter Lesions in Multiple Sclerosis
    - Brain vs. Skull (CT)
    - Brain Hemorrhage/Stroke (CT) 
</div>

## Overview of Work/Research

<div style='font-size: 28pt;'>
- **Neuroimaging and R (Neuroconductor Project)**
- **R Package Development**
- Segmentation/Classification of:
    - **White Matter Lesions in Multiple Sclerosis**
    - Brain vs. Skull (CT)
    - Brain Hemorrhage/Stroke (CT) 

</div>


# Brain Image Processing in R

----
<div class="container"> 
<div id="left_col2"> 
  <h2>Workflow for an Analysis</h2>
<div style='font-size: 32pt;'>

- bash <img src="figure/Bash-new-600x600.png" style="width:20%; display: inline; margin: auto;" alt="flow"> 
- FSL <img src="figure/FSL.png" style="width:20%; display: inline; margin: auto;" alt="flow"> 
- ANTs <img src="figure/ants.png" style="width:20%; display: inline; margin: auto;" alt="flow"> 
- MRIcroGL <img src="figure/mricrogl.png" style="width:20%; display: inline; margin: auto;" alt="flow"> 
- OsiriX <img src="figure/OsiriX.png" style="width:20%; display: inline; margin: auto;" alt="flow"> 
- SPM 12 <img src="figure/spm12.png" style="width:20%; display: inline; margin: auto;" alt="flow"> 

</div>
  </div>    
  <div id="right_col2">
<img src="figure/workflow_edited_nonR.png" style="width:70%; display: block; margin: auto;" alt="flow">
  </div>
</div>


----
<div class="container"> 
<div id="left_col2"> 
  <h2>Workflow for an Analysis</h2>
<div style='font-size: 32pt;'>
  
Multiple pieces of software used

  - all different syntax
</div>
  </div>    
  <div id="right_col2">
<img src="figure/workflow_edited_nonR.png" style="width:70%; display: block; margin: auto;" alt="flow">
  </div>
</div>


----
<div class="container"> 
<div id="left_col2"> 
  <h2>Goal: </h2>
<div style='font-size: 24pt;'>
  
Lower the bar to entry 

- all R code
    - pipeline tool
    - "native" R code

Complete pipeline
  
  - preprocessing and analysis
</div>
  </div>    
  <div id="right_col2">
<img src="figure/workflow_edited_R.png" style="width:70%; display: block; margin: auto;" alt="flow">
  </div>
</div>

## What did medical imaging in R have?

<img src="figure/imaging_task_view.png" style="width:100%; display: inline; margin: auto;" alt="flow">
  
## Bioinformatics Repository: Bioconductor<br> <img src="figure/biocview.png" style="width:100%; display: inline; margin: auto;" alt="flow"> 

## Bioinformatics Repository: Bioconductor<br> <img src="figure/bioconductor.png" style="width:65%; display: inline; margin: auto;" alt="flow"> 

- centralized bioinformatics/genomics packages
- large community/number of packages (> 1300)
- published tutorials and workflows 
- additional requirements to CRAN (e.g. packages need vignettes)


# <img src="figure/neuroconductor_brain_type_bbg.png" style="width:80%; display: inline; margin: auto;" alt="flow"><br> An R Platform for <br> Medical Imaging Analysis <br> [@neuroconductor]

## https://neuroconductor.org/ <img src="figure/neuroconductor_page.png" style="width:100%; display: inline; margin: auto;" alt="flow"> 


## Authored R Packages:

<div id="wrap">
<div id="left_col">

- **fslr** <p style='font-size: 12pt;'>(Muschelli, John, et al. "fslr: Connecting the FSL Software with R." R JOURNAL 7.1 (2015): 163-175.)</p>
- brainR <p style='font-size: 12pt;'>(Muschelli, John, Elizabeth Sweeney, and Ciprian Crainiceanu. "brainR: Interactive 3 and 4D Images of High Resolution Neuroimage Data." R JOURNAL 6.1 (2014): 42-48.)</p>
- ichseg <p style='font-size: 12pt;'>Muschelli, John, et al. "PItcHPERFeCT: Primary intracranial hemorrhage probability estimation using random forests on CT." NeuroImage: Clinical 14 (2017): 379-390.</p>
- extrantsr
- dcm2niir
- matlabr
- spm12r
- freesurfer


</div>
<div id="right_col">

- itksnapr
- stapler
- gifti
- cifti
- papayar
- diffr
- gcite
- rscopus
- fedreporter
- glassdoor

</div>
</div>




## Number of Downloads (from `cranlogs`)


```{r cranlogs, cache = TRUE, eval = TRUE}
if (!require(cranlogs)) {
  library(devtools)
  install_github("metacran/cranlogs")
}
first_date = "2014-01-10"
today = Sys.Date()
long_today = format(Sys.time(), "%B %d, %Y")
packs = c("brainR", "cifti", "diffr", "fedreporter", "freesurfer", "fslr", 
"gcite", "gifti", "glassdoor", "kirby21.base", "kirby21.fmri", 
"kirby21.t1", "matlabr", "neurobase", "neurohcp", "neurovault", 
"papayar", "rscopus", "spm12r", "stapler", "WhiteStripe")
last_week = cran_downloads( when = "last-week",
                            packages = packs)
last_week = plyr::ddply(last_week, plyr::.(package), summarise, 
                  Last_Week = sum(count))
dl = cran_downloads( from = first_date, to = today,
                     packages = packs)
dl = plyr::ddply(dl, plyr::.(package), summarise, All_Time = sum(count))
dl = merge(dl, last_week)
dl = plyr::arrange(dl, plyr::desc(Last_Week))
colnames(dl) = c("Package", "All Time", "Last Week")
```



```{r dt_library}
library(DT)
```

```{r dt_cranlogs, results = "asis", eval = TRUE, dependson = "cranlogs"}
datatable(dl, filter = "none", selection = "none", rownames = FALSE,
          options = list(dom = 't', autoWidth = TRUE,
                         columnDefs = list(list(
                           className = 'dt-center',
                           targets = 0)))
)
```


# Lesion Segmentation of MS

## Public Dataset with Lesion Segmentation

* "A novel public MR image dataset of multiple sclerosis patients with lesion segmentations based on multi-rater consensus" [@msdata]
  - Data Published at http://lit.fe.uni-lj.si/tools.php?lang=eng
  - 30 subjects with MRI (3T Siemens Trio)
- Manually segmented by 3 expert raters 
- Creative-Commons Attribution (CC-BY)
- All analysis and data located: https://github.com/muschellij2/open_ms_data
  
## Demographic Data
- On many different therapies (9 no therapy), age IQR: `r quantile (cs$Age, probs = 0.25)` - `r quantile (cs$Age, probs = 0.75)`

```{r, results = "asis"}
knitr::kable(tabAsStringMatrix)
```


## Imaging Data

* 2D T1 (TR=2000ms, TE=20ms, TI=800ms) and after gadolinium
* 2D T2 (TR=6000ms, TE=120ms), 3D FLAIR (TR=5000ms, TE=392ms, TI=1800 ms)
    - Fluid attenuated inversion recovery - reduce signal of fluids
- All had flip angle of 120$^{\circ}$

</div>
<div>
<img src="figure/overlay.png" style="width:100%;  display: block; margin: auto;" alt="OVERLAY">
</div>


<!-- The obtained median DSC values were 0.85 and 0.82 for -->
<!-- intra- and inter-rater variability using manual tools, while -->
<!-- the respective values obtained with the semi-automated -->
<!-- tools were 0.92 and 0.89. -->




## Terminology: Neuroimaging to Data/Statistics

<div style="font-size: 26pt">
* Segmentation ⇔ classification 
* Image ⇔ 3-dimensional array
* Mask/Region of Interest ⇔ binary (0/1) image 
* Registration ⇔  Spatial Normalization/Standarization
    - "Lining up" Brains
</div>


## Image Representation: voxels (3D pixels)
<div id="left_col2"> 
<img src="figure/Zoom_Ventricle.png" style="width:100%;  display: block; margin: auto;">
</div>
</div>    
<div id="right_col2">
<img src="figure/movie_final.gif" style="width:80%; display: block; margin: auto;" loop=infinite>
<p style='font-size: 10pt;'></p>
</div>


## Step 1: Image Processing <img src="figure/processing_workflow.png" style="width:30%; display: block; margin: auto;"> 

## Step 1: Image Processing

<div class="container">
<div id="left_col">
Figure from Multi-Atlas Skull Stripping method paper [@mass]:

<img src="figure/malf_figure.jpg" style="width: 60%; display: block; margin: auto;">
</div>
<div id="right_col">
- Register templates to an image using the T1 for that subject
- Apply transformation to the label/mask
- Average each voxel over all templates
    - there are "smarter" (e.g. weighted) ways
</div>
</div>

## Step 2: Create Predictors for each Sequence 

<div id="left_col">
<img src="figure/ms_covariates.png" style="width:100%; display: block; margin: auto;" alt="Preds">  
</div> 
<div id="right_col"> 
- Quantile images, smoothers, local moments
- Tissue class probability
- Z-score to a population template 
</div>

## A package to do all this

- All processing located in `smri.process` GitHub package (`muschellij2/smri.process`)

<img src="figure/processing_code.png" style="width:45%; display: block; margin: auto;" alt="code">

## Data Structure for One Patient <br/> <img src="figure/ms_voxel_stacking.png" style="width:70%;  display: block; margin: auto;" alt="Vox stack">  

---

<div class="container"> 
<div id="left_col2"> 
  <h2>Step 3: Aggregate Data</h2>
  Training Data Structure
  
  * Sample `10%` of the voxels (save computation time)
  * Stack together `r sum(df$group== "train")` randomly selected patients, stratified by age (over median) and volume
  * Train model/classifier on this design matrix
  * Smooth the probability map
  * Test on `r sum(df$group== "test")` hold out
  
  </div>    
  <div id="right_col2">
  <img src="figure/Large_Design_Matrix_small.jpg" style="width:45%;  display: block; margin: auto;" alt="MISTIE LOGO">  
  </div> 
</div>


## Step 4: Fit Models / Classifier

Let $y_{i}(v)$ be the presence / absence of lesion for voxel $v$ from person $i$.  

General model form: 
$$
 P(Y_{i}(v) = 1)  \propto f(X_{i}(v))
$$
- Similar thinking in OASIS: logistic regression with images + interaction of the image and a 10mm$^3$ and 20mm$^3$ smoother [@oasis]. 
$$
f(X_{i}(v)) = \text{expit} \left\{ \beta_0 + \sum_{k \in \{T1, T2, FLAIR, PD\}} x_{k}(v)\beta_{k} +  x_{k}(v) * x_{10, k} \beta_{10,k} +  x_{k}(v)* x_{20, k} \beta_{20,k}\right\}  
$$
Does not include T1Post, but did include PD originally
  - With the original model from the paper and a re-trained model

## Models Fit on the Training Data

- Logistic Regression: \(f(X_{i}(v)) = \text{expit} \left\{ \beta_0 + \sum_{k= 1}^{p} x_{i, k}(v)\beta_{k}\right\}  \), $p = 85$
- Random Forests [@ranger], [@breiman2001random]
  - With 5 fold cross-validation, default 500 trees, mtry: $\sqrt{p}$
  - With and without the T1-Post for comparison to OASIS
<div class="centerer">
\(f(X_{i}(v)) \propto\) <img src="figure/Random_Forest.png" style="width:40%;inline;" alt="RF">
- Estimate a probability cutoff on training data
- Predict on test data, assess performance acrosss all voxels in the brain


## Assessing Performance 
For each test scan, and over all test scans, we can calculate the following 2-by-2 table, where the cells represent number of voxels and a corresponding Venn diagram:

<div style="width:45%;float: left;">
<table class = 'rmdtable' style='font-size: 26px;'>
<tr class = "header"><td></td><td></td><td colspan="2">Manual</td></tr>
<tr class = "header"><td></td><td></td><td>0</td><td>1</td></tr>
<tr><td rowspan="2"> PitCH</td><td>0</td><td style='font-size: 40px;'>TN</td><td style="color:blue">FN</td></tr>
<tr><td>1</td><td style="color:red">FP</td><td style="color:purple">TP</td></tr>
</table>
</div>
<div style="margin-left:48%;">
<img src="figure/Venn_Diagram_labeled.png" style="width:80%; display: block; margin: auto;">
</div>


## Dice Results (Triangle is population Dice) <img src="figure/ranger_dice_results.png" style="width:55%;  display: block; margin: auto;" alt="Reseg">

## <img src="figure/varimp.png" style="width:60%;  display: block; margin: auto;" alt="Reseg">


## RF Predicted Volume Estimates True Volume <img src="figure/volume_results.png" style="width:90%;  display: block; margin: auto;" alt="Reseg">

## OASIS: not so much <img src="figure/volume_results_oasis.png" style="width:90%;  display: block; margin: auto;" alt="Reseg">

## Patient with Median DSI (`r round(id$dice, 2)`) in Test

<!-- <img src="figure/low_dice.gif" style="width:55%;  display: block; margin: auto;" alt="Median">  -->

<div class="left-half">
<img src="figure/patient28_image.png" style="width:100%;  display: block; margin: auto;" alt="Median">
</div>
<div class="right-half">
<img src="figure/patient28_ranger_smoothed_phat.png" style="width:100%;  display: block; margin: auto;" alt="Median">
</div>

## Patient with High DSI (`r round(id_high$dice, 2)`) in Test

<!-- <img src="figure/high_dice.gif" style="width:55%;  display: block; margin: auto;" alt="Median">  -->


<div class="left-half">
<img src="figure/patient04_image.png" style="width:100%;  display: block; margin: auto;" alt="Median">
</div>
<div class="right-half">
<img src="figure/patient04_ranger_smoothed_phat.png" style="width:100%;  display: block; margin: auto;" alt="Median">
</div>


## Brain Stem Lesions Estimated

<div class="left-half">
<img src="figure/patient07_image.png" style="width:100%;  display: block; margin: auto;" alt="Median">
</div>
<div class="right-half">
<img src="figure/patient07_ranger_smoothed_phat.png" style="width:100%;  display: block; margin: auto;" alt="Median">
</div>


## Conclusions of Lesion Analyses

<div style="font-size: 24pt">

- We can segment MS lesions reasonably well <br><br>
- Better models with larger samples  <br/><br/>
- Needs to be more stable/accurate for a biomarker 
    - Location may also be relevant and not taken into account
    - Is the brain stem an area we should focus on or remove from assessment?

</div>


## Next Steps/Questions

<div style="font-size: 24pt">
- Run new processing the 131 patients from OASIS paper 
- Gray matter injury estimation
- Is EDSS the clinical score we should be relating this to?
- "Black hole" lesions using the T1-post image, these may show "active" lesions
</div>



## Thank You

